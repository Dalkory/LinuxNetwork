# Сети в Linux

1. [Инструмент ipcalc](#part-1-инструмент-ipcalc)
2. [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами)
3. [Утилита iperf3](#part-3-утилита-iperf3)
4. [Сетевой экран](#part-4-сетевой-экран)
5. [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)
6. [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
7. [NAT](#part-7-nat)
8. [Допополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Part 1. Инструмент **ipcalc**

##### Поднять виртуальную машину (далее -- ws1)

- `sudo hostnamectl set-hostname ws1`

#### 1.1. Сети и маски

- `sudo apt install ipcalc`

##### Определить и записать в отчёт:

##### 1) адрес сети *192.167.38.54/13*

- `ipcalc -b 192.167.38.54/13`

![ipcalc -b 192.167.38.54/13](image.png)

 - Флаг `-b` позволяет скрыть двоичный вывод.

##### 2) перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную

- `ipcalc 255.255.255.0`

![ipcalc 255.255.255.0](image-1.png)

Префиксная запись - `/24`. Двоичная запись - `11111111.11111111.11111111.00000000`

- `ipcalc /15`

![ipcalc /15](image-2.png)

Обычная запись - `255.254.0.0`. Двоичная запись - `11111111.11111110.00000000.00000000`

- `ipcalc 192.167.38.54/28`

![ipcalc 192.167.38.54/28](image-3.png)

Обычная запись - `255.255.255.240`. Префиксная запись - `/28`

##### 3) минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

- `ipcalc 12.167.38.4/8`

![ipcalc 12.167.38.4/8](image-4.png)

Минимальный хост - `12.0.0.1`. Максимальный хост - `12.255.255.254`

- `ipcalc 12.167.38.4/16`

![ipcalc 12.167.38.4/16](image-5.png)

Минимальный хост - `12.167.0.1`. Максимальный хост - `12.167.255.254`

- `ipcalc 12.167.38.4/23`

![ipcalc 12.167.38.4/23](image-6.png)

Минимальный хост - `12.167.38.1`. Максимальный хост - `12.167.39.254`

- `ipcalc 12.167.38.4/4`

![ipcalc 12.167.38.4/4](image-7.png)

Минимальный хост - `0.0.0.1`. Максимальный хост - `15.255.255.254`

#### 1.2. localhost

##### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

- localhost («местный» от англ. local — этот компьютер) — стандартное, официально зарезервированное доменное имя для частных IP-адресов в диапазоне 127.0.0.1 — 127.255.255.254.

- `ipcalc 194.34.23.100`

![ipcalc 194.34.23.100](image-8.png)

Интерфейс Loopback отсутствует в строке `Hosts/Net`, следовательно данный адрес нам не подходит.

- `ipcalc 127.0.0.2`

![ipcalc 127.0.0.2](image-9.png)

Loopback присутствует, следовательно адрес нам подходит.

- `ipcalc 127.1.0.1`

![ipcalc 127.1.0.1](image-10.png)

Loopback присутствует, следовательно адрес нам подходит.

- `ipcalc 128.0.0.1`

![ipcalc 128.0.0.1](image-11.png)

Интерфейс Loopback отсутствует в строке `Hosts/Net`, следовательно данный адрес нам не подходит.

#### 1.3. Диапазоны и сегменты сетей

##### Определить и записать в отчёт:

##### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

- `ipcalc <ip адрес>` 

(чтобы не нагромождать скринами, пишу словами.)
```bash
10.0.0.45/8       - Privat
134.43.0.2/16     - Public
192.168.4.2/16    - Privat
172.20.250.4/12   - Privat
172.0.2.1/12      - Public
192.172.0.1/12    - Public
172.68.0.2/12     - Public
172.16.255.255/12 - Privat
10.10.10.10/8     - Privat
192.169.168.1/16  - Public
```

##### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

- `ipcalc -b 10.10.0.0/18`

![ipcalc -b 10.10.0.0/18](image-12.png)

Возможны адреса `10.10.0.2`, `10.10.10.10` и `10.10.1.255`

## Part 2. Статическая маршрутизация между двумя машинами

##### Поднять две виртуальные машины (далее -- ws1 и ws2)

- `sudo hostnamectl set-hostname ws2`

##### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

![ip a](image-13.png)

##### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*

- `в виртуал боксе открыть настройки машин открыть там настройки сетей и включить адаптер 2 там выбрать пункт “внутренняя сеть».`

- `sudo nano /etc/netplan/00-installer-config.yaml`

![ws1](image-17.png)

![ws2](image-18.png)

##### Выполнить команду `sudo netplan apply` для перезапуска сервиса сети

#### 2.1. Добавление статического маршрута вручную

##### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`

![sudo ip r ws1](image-19.png)

![sudo ip r ws2](image-20.png)

##### Пропинговать соединение между машинами

![ping](image-21.png)

#### 2.2. Добавление статического маршрута с сохранением

##### Перезапустить машины

- `reboot`

##### Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*

![00-insta](image-22.png)

##### Пропинговать соединение между машинами

![ping - too](image-23.png)

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения

##### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps = 1024 Mbps

#### 3.2. Утилита **iperf3**

##### Измерить скорость соединения между ws1 и ws2

- `iperf3 -s`

- `iperf3 -c 192.168.100.10`

![iperf3](image-24.png)

## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**

##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:

- `sudo nano /etc/firewall.sh`

##### Нужно добавить в файл подряд следующие правила:
##### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
##### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
##### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
##### 4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
##### 5) разрешить *echo reply* (машина должна "пинговаться")


ws1:

![ws1](image-25.png)

- в начале запрещаем `echo-reply`

ws2: 

![ws2](image-26.png)

- в конце запрещаем `echo-reply`

##### Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`

![ws1-1](image-27.png)

![ws2-2](image-28.png)

- Разница между стратегиями заключается в том, что в первом файле первым подходящим правилом для пакета является запрет, а во втором - разрешение. Применяется только первое подходящее правило, остальные игнорируются.

#### 4.2. Утилита **nmap**

##### Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен
*Проверка: в выводе nmap должно быть сказано: `Host is up`*

![Host](image-29.png)

## Part 5. Статическая маршрутизация сети

![part5_network](misc/images/part5_network.png)

##### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

#### 5.1. Настройка адресов машин

##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

r1 - ![r1](image-32.png)

r2 - ![r2](image-31.png)

ws11 - ![ws11](image-33.png)

ws21 - ![ws21](image-34.png)

ws22 - ![ws22](image-35.png)

- `sudo netplan apply`

##### Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

- ws11 and r1

![ws11 and r1](image-37.png)

- r1

![r1-1](image-38.png)

- ws21 and ws22

![ws21-22](image-39.png)

- ws22 and ws21

![ws22-21](image-41.png)

- r2

![r2-1](image-42.png)

#### 5.2. Включение переадресации IP-адресов.

##### Для включения переадресации IP, выполните команду на роутерах:

`sudo sysctl -w net.ipv4.ip_forward=1`

![r1-r2](image-43.png)

##### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку:

`net.ipv4.ip_forward = 1`

![r1-r2--#](image-44.png)

#### 5.3. Установка маршрута по-умолчанию

##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций

![gateway4](image-45.png)

##### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации

![dafault](image-46.png)

##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`

![tcpdump](image-47.png)

#### 5.4. Добавление статических маршрутов

##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:

![net-00](image-48.png)

##### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.

![ip-r](image-49.png)

##### Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![list](image-50.png)

- Маршрут по умолчанию имеет более низкий приоритет и срабатывает, когда не найден подходящий маршрут в таблице маршрутизации. Для сети 10.10.0.0 мы создали правило, соответственно используется созданный маршрут. Также можно устанавливать метрику, чтобы менять приоритеты маршрутов.

#### 5.5. Построение списка маршрутизаторов

##### Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`

##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21

![ws11](image-51.png)

- вывод tcpdump -tnv -i enp0s9 на r1

![tcpdump](image-52.png)

- Принцип построения пути при помощи traceroute: Для определения промежуточных маршрутизаторов traceroute отправляет серию пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первый пакет отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, равным 2, что позволяет первому маршрутизатору пропустить пакет дальше. Процесс повторяется до тех пор, пока при определённом значении TTL пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

#### 5.6. Использование протокола **ICMP** при маршрутизации

##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`

![tcpdump -n -i](image-53.png)

##### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 5 10.30.0.111`

![ping -c 5](image-54.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:

##### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. 

![dhcp](image-55.png)


##### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![nameserver](image-56.png)

##### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

![restart](image-57.png)

- Перезагружаем ws21 с помощью команды `sudo reboot`

![ip a](image-58.png)

![ping](image-59.png)

##### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

![mac](image-66.png)

##### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

- вносим изменения в файл /etc/dhcp/dhcpd.conf

![r1](image-61.png)

- вносим изменения в файл /etc/resolv.conf

![nameserv](image-62.png)

- перезагружаем службу DHCP

![r1-dhcp](image-63.png)

- перезагружаем ws11 и вызываем ip a

![ip a](image-67.png)

- пингуем ws22

![ping](image-68.png)

##### Запросить с ws21 обновление ip адреса

![ip](image-69.png)

- вызываем команду `sudo dhclient enp0s8 -r`, потом `sudo dhclient enp0s8`

![dhclient](image-70.png)

- `sudo dhclint -r enp0x` удалить IP

- `sudo dhclint  enp0X` назначить IP

## Part 7. **NAT**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

- `sudo apt inastall apache2 -y`

![r1](image-72.png)

![ws22](image-73.png)

##### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

![start r1](image-74.png)

![start ws22](image-75.png)

##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

##### 1) удаление правил в таблице filter - `iptables -F`

##### 2) удаление правил в таблице "NAT" - `iptables -F -t nat`

##### 3) отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

![fire](image-77.png)

##### Запускать файл также, как в Части 4

![sh](image-78.png)

##### Проверить соединение между ws22 и r1 командой `ping`

![not ping r1](image-79.png)

![not ping ws22](image-80.png)

##### Добавить в файл ещё одно правило:

##### 4) разрешить маршрутизацию всех пакетов протокола **ICMP**

![++1](image-81.png)

##### Запускать файл также, как в Части 4

![start sh](image-82.png)

##### Проверить соединение между ws22 и r1 командой `ping`

![ping norm](image-83.png)

##### Добавить в файл ещё два правила:

##### 5) включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

##### 6) включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![++++++++++++](image-84.png)

##### Запускать файл также, как в Части 4

![sh++](image-85.png)

##### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`

![telnet-ws22](image-86.png)

##### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)

![telnet-r1](image-87.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

- `sudo apt-get install openssh-server`

##### Запустить на r2 фаервол с правилами из Части 7

![++++++++++++](image-84.png)

![sh++](image-85.png)

##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)

![local](image-90.png)

![start](image-89.png)

##### Воспользоваться *Local(-L) TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

- добавить пользователя ws21 на машину ws22

![new](image-91.png)

![localhost](image-93.png)

##### Воспользоваться *Remote(-R) TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

- добавить пользователя ws11 на машину ws22

![new-1](image-92.png)

![localhost-1](image-95.png)

##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`

![telnet](image-94.png)

![telnet-1](image-96.png)